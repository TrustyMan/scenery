define(function(e){"use strict";var o=e("SCENERY/accessibility/AccessibilityTree"),s=e("DOT/Dimension2"),t=e("AXON/Emitter"),c=e("PHET_CORE/escapeHTML"),n=e("AXON/Events"),i=e("PHET_CORE/extend"),r=e("PHET_CORE/inherit"),u=e("DOT/Matrix3"),a=e("AXON/Property"),l=e("AXON/PropertyIO"),h=e("TANDEM/Tandem"),d=e("SCENERY/util/Features"),p=e("SCENERY/nodes/Node"),w=e("SCENERY/scenery");e("SCENERY/display/BackboneDrawable"),e("SCENERY/display/CanvasBlock"),e("SCENERY/display/CanvasSelfDrawable");var g=e("SCENERY/display/ChangeInterval");e("SCENERY/display/DOMSelfDrawable");var y=e("SCENERY/display/Drawable"),b=e("SCENERY/display/Instance");e("SCENERY/display/InlineCanvasCacheDrawable");var f=e("SCENERY/display/Renderer");e("SCENERY/display/SharedCanvasCacheDrawable"),e("SCENERY/display/SVGSelfDrawable");var m=e("SCENERY/input/Input");e("SCENERY/util/Trail");var v=e("SCENERY/accessibility/AccessibleInstance"),D=e("SCENERY/overlays/CanvasNodeBoundsOverlay"),C=e("SCENERY/overlays/FittedBlockBoundsOverlay"),L=e("SCENERY/accessibility/FocusIO"),E=e("SCENERY/overlays/FocusOverlay"),S=e("TANDEM/types/NullableIO"),k=e("PHET_CORE/platform"),I=e("SCENERY/overlays/PointerAreaOverlay"),T=e("SCENERY/overlays/PointerOverlay"),O=e("SCENERY/util/SceneryStyle"),B=e("SCENERY/util/Util");function N(e,t){assert&&assert(e,"rootNode is a required parameter"),n.call(this),t=_.extend({width:t&&t.container&&t.container.clientWidth||640,height:t&&t.container&&t.container.clientHeight||480,allowCSSHacks:!0,allowSceneOverflow:!1,defaultCursor:"default",backgroundColor:null,preserveDrawingBuffer:!1,allowWebGL:!0,accessibility:!0,isApplication:!1,interactive:!0,listenToOnlyElement:!1,batchDOMEvents:!1,assumeFullWindow:!1,aggressiveContextRecreation:!0,passiveEvents:!k.safari&&null,allowBackingScaleAntialiasing:!0},t),this.options=t,this._accessible=t.accessibility,this._allowWebGL=t.allowWebGL,this._size=new s(this.options.width,this.options.height),this._currentSize=new s(-1,-1),this._rootNode=e,this._rootNode.addRootedDisplay(this),this._rootBackbone=null,this._domElement=t&&t.container?w.BackboneDrawable.repurposeBackboneContainer(t.container):w.BackboneDrawable.createDivBackbone(),this._sharedCanvasInstances={},this._baseInstance=null,this._frameId=0,this._dirtyTransformRoots=[],this._dirtyTransformRootsWithoutPass=[],this._instanceRootsToDispose=[],this._drawablesToDispose=[],this._drawablesToChangeBlock=[],this._drawablesToUpdateLinks=[],this._changeIntervalsToDispose=[],this._lastCursor=null,this._currentBackgroundCSS=null,this._backgroundColor=null,this._requestAnimationFrameID=0,this._input=null,this._inputListeners=[],this._interactive=this.options.interactive,this._listenToOnlyElement=t.listenToOnlyElement,this._batchDOMEvents=t.batchDOMEvents,this._assumeFullWindow=t.assumeFullWindow,this._passiveEvents=t.passiveEvents,this._aggressiveContextRecreation=t.aggressiveContextRecreation,this._allowBackingScaleAntialiasing=t.allowBackingScaleAntialiasing,this._overlays=[],this._pointerOverlay=null,this._pointerAreaOverlay=null,this._canvasAreaBoundsOverlay=null,this._fittedBlockBoundsOverlay=null,assert&&(this._isPainting=!1),this.applyCSSHacks(),this.setBackgroundColor(this.options.backgroundColor),this.scenery=w,this.options.accessibility&&(this.options.isApplication&&this._domElement.setAttribute("aria-role","application"),O.addRule(".accessibility * { position: relative; left: -1000px; top: 0; width: 250px; height: 0; clip: rect(0,0,0,0); pointerEvents: none }"),this._focusRootNode=new p,this._focusOverlay=new E(this,this._focusRootNode),this.addOverlay(this._focusOverlay),this._unsortedAccessibleInstances=[],this.pointerFocus=null,this.activeNode=null,this._focusedNodeOnRemoveTrail,this._rootAccessibleInstance=v.createFromPool(null,this,new w.Trail),sceneryLog&&sceneryLog.AccessibleInstance&&sceneryLog.AccessibleInstance("Display root instance: "+this._rootAccessibleInstance.toString()),o.rebuildInstanceTree(this._rootAccessibleInstance),this._domElement.appendChild(this._rootAccessibleInstance.peer.primarySibling))}return w.register("Display",N),r(Object,N,i({getDOMElement:function(){return this._domElement},get domElement(){return this.getDOMElement()},updateDisplay:function(){if(!window.sceneryDebugPause){sceneryLog&&w.isLoggingPerformance()&&(this.perfSyncTreeCount=0,this.perfStitchCount=0,this.perfIntervalCount=0,this.perfDrawableBlockChangeCount=0,this.perfDrawableOldIntervalCount=0,this.perfDrawableNewIntervalCount=0),assert&&N.assertSubtreeDisposed(this._rootNode),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("updateDisplay frame "+this._frameId),sceneryLog&&sceneryLog.Display&&sceneryLog.push();var e=!!this._baseInstance;for(this._input&&this._input.validatePointers(),this._rootNode.validateWatchedBounds(),assertSlow&&this.options.accessibility&&this._rootAccessibleInstance.auditRoot(),assertSlow&&this._rootNode._picker.audit(),this._baseInstance=this._baseInstance||w.Instance.createFromPool(this,new w.Trail(this._rootNode),!0,!1),this._baseInstance.baseSyncTree(),e&&this.markTransformRootDirty(this._baseInstance,this._baseInstance.isTransformed);this._drawablesToUpdateLinks.length;)this._drawablesToUpdateLinks.pop().updateLinks();for(;this._changeIntervalsToDispose.length;)this._changeIntervalsToDispose.pop().dispose();for(this._rootBackbone=this._rootBackbone||this._baseInstance.groupDrawable,assert&&assert(this._rootBackbone,"We are guaranteed a root backbone as the groupDrawable on the base instance"),assert&&assert(this._rootBackbone===this._baseInstance.groupDrawable,"We don't want the base instance's groupDrawable to change"),assertSlow&&this._rootBackbone.audit(!0,!1,!0),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("drawable block change phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push();this._drawablesToChangeBlock.length;){var t=this._drawablesToChangeBlock.pop().updateBlock();sceneryLog&&w.isLoggingPerformance()&&t&&this.perfDrawableBlockChangeCount++}for(sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assertSlow&&this._rootBackbone.audit(!1,!1,!0),assertSlow&&this._baseInstance.audit(this._frameId,!1),this.updateDirtyTransformRoots(),this._baseInstance.updateVisibility(!0,!0,!1),assertSlow&&this._baseInstance.auditVisibility(!0),assertSlow&&this._baseInstance.audit(this._frameId,!0),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("instance root disposal phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push();this._instanceRootsToDispose.length;)this._instanceRootsToDispose.pop().dispose();for(sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assertSlow&&this._rootNode.auditInstanceSubtreeForDisplay(this),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("drawable disposal phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push();this._drawablesToDispose.length;)this._drawablesToDispose.pop().dispose();if(sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assertSlow&&this._baseInstance.audit(this._frameId),assert&&(assert(!this._isPainting,"Display was already updating paint, may have thrown an error on the last update"),this._isPainting=!0),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("repaint phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push(),this._rootBackbone.update(),sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assert&&(this._isPainting=!1),assertSlow&&this._rootBackbone.audit(!1,!1,!1),assertSlow&&this._baseInstance.audit(this._frameId),this.updateCursor(),this.updateBackgroundColor(),this.updateSize(),this._overlays.length)for(var s=this._rootBackbone.lastZIndex,n=0;n<this._overlays.length;n++){var i=this._overlays[n];i.domElement.style.zIndex=s++,i.update()}if(this._frameId++,sceneryLog&&w.isLoggingPerformance()){var r="syncTree count: "+this.perfSyncTreeCount;500<this.perfSyncTreeCount?sceneryLog.PerfCritical&&sceneryLog.PerfCritical(r):100<this.perfSyncTreeCount?sceneryLog.PerfMajor&&sceneryLog.PerfMajor(r):20<this.perfSyncTreeCount?sceneryLog.PerfMinor&&sceneryLog.PerfMinor(r):0<this.perfSyncTreeCount&&sceneryLog.PerfVerbose&&sceneryLog.PerfVerbose(r);var a="drawable block changes: "+this.perfDrawableBlockChangeCount+" for -"+this.perfDrawableOldIntervalCount+" +"+this.perfDrawableNewIntervalCount;200<this.perfDrawableBlockChangeCount?sceneryLog.PerfCritical&&sceneryLog.PerfCritical(a):60<this.perfDrawableBlockChangeCount?sceneryLog.PerfMajor&&sceneryLog.PerfMajor(a):10<this.perfDrawableBlockChangeCount?sceneryLog.PerfMinor&&sceneryLog.PerfMinor(a):0<this.perfDrawableBlockChangeCount&&sceneryLog.PerfVerbose&&sceneryLog.PerfVerbose(a)}o.auditAccessibleDisplays(this.rootNode),sceneryLog&&sceneryLog.Display&&sceneryLog.pop()}},updateSize:function(){var e=!1;this._size.width!==this._currentSize.width&&(e=!0,this._currentSize.width=this._size.width,this._domElement.style.width=this._size.width+"px"),this._size.height!==this._currentSize.height&&(e=!0,this._currentSize.height=this._size.height,this._domElement.style.height=this._size.height+"px"),e&&!this.options.allowSceneOverflow&&(this._domElement.style.clip="rect(0px,"+this._size.width+"px,"+this._size.height+"px,0px)")},getRootNode:function(){return this._rootNode},get rootNode(){return this.getRootNode()},getSize:function(){return this._size},get size(){return this.getSize()},getBounds:function(){return this._size.toBounds()},get bounds(){return this.getBounds()},setSize:function(e){assert&&assert(e instanceof s),assert&&assert(e.width%1==0,"Display.width should be an integer"),assert&&assert(0<e.width,"Display.width should be greater than zero"),assert&&assert(e.height%1==0,"Display.height should be an integer"),assert&&assert(0<e.height,"Display.height should be greater than zero"),this._size.equals(e)||(this._size=e,this.trigger1("displaySize",this._size))},setWidthHeight:function(e,t){this.setSize(new s(e,t))},getWidth:function(){return this._size.width},get width(){return this.getWidth()},setWidth:function(e){assert&&assert("number"==typeof e,"Display.width should be a number"),this.getWidth()!==e&&this.setSize(new s(e,this.getHeight()))},set width(e){this.setWidth(e)},getHeight:function(){return this._size.height},get height(){return this.getHeight()},setHeight:function(e){assert&&assert("number"==typeof e,"Display.height should be a number"),this.getHeight()!==e&&this.setSize(new s(this.getWidth(),e))},set height(e){this.setHeight(e)},setBackgroundColor:function(e){assert&&assert(null===e||"string"==typeof e||e instanceof w.Color),this._backgroundColor=e},set backgroundColor(e){this.setBackgroundColor(e)},getBackgroundColor:function(){return this._backgroundColor},get backgroundColor(){return this.getBackgroundColor()},get interactive(){return this._interactive},set interactive(e){this._interactive=e,!this._interactive&&this._input&&(this._input.interruptPointers(),this._input.clearBatchedEvents(),this._input.removeTemporaryPointers(),this._rootNode.interruptSubtreeInput()),this.options.accessibility&&(this._interactive||(this.activeNode=N.focusedNode,this.activeNode&&this.activeNode.blur()),this.accessibleDOMElement.hidden=!this._interactive)},addOverlay:function(e){this._overlays.push(e),this._domElement.appendChild(e.domElement),e.domElement.setAttribute("aria-hidden",!0)},removeOverlay:function(e){this._domElement.removeChild(e.domElement),this._overlays.splice(_.indexOf(this._overlays,e),1)},markUnsortedAccessibleInstance:function(e){this._unsortedAccessibleInstances.push(e)},sortAccessibleInstances:function(){for(var e=N.focusedNode;this._unsortedAccessibleInstances.length;)this._unsortedAccessibleInstances.pop().sortChildren();e&&e.focus()},getAccessibleDOMElement:function(){return this._rootAccessibleInstance.peer.primarySibling},get accessibleDOMElement(){return this.getAccessibleDOMElement()},getUsedRenderersBitmask:function(){return function t(e){var s=0;return _.each(e.blocks,function(e){e instanceof w.DOMBlock&&e.domDrawable instanceof w.BackboneDrawable?s|=t(e.domDrawable):s|=e.renderer}),s}(this._rootBackbone)&f.bitmaskRendererArea},markTransformRootDirty:function(e,t){t?this._dirtyTransformRoots.push(e):this._dirtyTransformRootsWithoutPass.push(e)},updateDirtyTransformRoots:function(){for(sceneryLog&&sceneryLog.transformSystem&&sceneryLog.transformSystem("updateDirtyTransformRoots"),sceneryLog&&sceneryLog.transformSystem&&sceneryLog.push();this._dirtyTransformRoots.length;)this._dirtyTransformRoots.pop().relativeTransform.updateTransformListenersAndCompute(!1,!1,this._frameId,!0);for(;this._dirtyTransformRootsWithoutPass.length;)this._dirtyTransformRootsWithoutPass.pop().relativeTransform.updateTransformListenersAndCompute(!1,!1,this._frameId,!1);sceneryLog&&sceneryLog.transformSystem&&sceneryLog.pop()},markDrawableChangedBlock:function(e){assert&&assert(e instanceof y),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("markDrawableChangedBlock: "+e.toString()),this._drawablesToChangeBlock.push(e)},markInstanceRootForDisposal:function(e){assert&&assert(e instanceof b,"How would an instance not be an instance of an instance?!?!?"),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("markInstanceRootForDisposal: "+e.toString()),this._instanceRootsToDispose.push(e)},markDrawableForDisposal:function(e){assert&&assert(e instanceof y),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("markDrawableForDisposal: "+e.toString()),this._drawablesToDispose.push(e)},markDrawableForLinksUpdate:function(e){assert&&assert(e instanceof y),this._drawablesToUpdateLinks.push(e)},markChangeIntervalToDispose:function(e){assert&&assert(e instanceof g),this._changeIntervalsToDispose.push(e)},updateBackgroundColor:function(){assert&&assert(null===this._backgroundColor||"string"==typeof this._backgroundColor||this._backgroundColor instanceof w.Color);var e=null===this._backgroundColor?"":this._backgroundColor.toCSS?this._backgroundColor.toCSS():this._backgroundColor;e!==this._currentBackgroundCSS&&(this._currentBackgroundCSS=e,this._domElement.style.backgroundColor=e)},updateCursor:function(){if(this._input&&this._input.mouse&&this._input.mouse.point){if(this._input.mouse.cursor)return sceneryLog&&sceneryLog.Cursor&&sceneryLog.Cursor("set on pointer: "+this._input.mouse.cursor),this.setSceneCursor(this._input.mouse.cursor);var e=this._rootNode.trailUnderPointer(this._input.mouse);if(e)for(var t=e.getCursorCheckIndex();0<=t;t--){var s=e.nodes[t],n=s.getCursor();if(n)return sceneryLog&&sceneryLog.Cursor&&sceneryLog.Cursor(n+" on "+s.constructor.name+"#"+s.id),this.setSceneCursor(n)}sceneryLog&&sceneryLog.Cursor&&sceneryLog.Cursor("--- for "+(e?e.toString():"(no hit)"))}return this.setSceneCursor(this.options.defaultCursor)},setSceneCursor:function(e){if(e!==this._lastCursor){this._lastCursor=e;var t=N.customCursors[e];if(t)for(var s=t.length-1;0<=s;s--)this._domElement.style.cursor=t[s];else this._domElement.style.cursor=e}},applyCSSHacks:function(){this.options.allowSceneOverflow||(this._domElement.style.overflow="hidden"),document.onselectstart=function(){return!1},this._domElement.style.msTouchAction="none",d.setStyle(this._domElement,d.fontSmoothing,"antialiased"),this.options.allowCSSHacks&&(d.setStyle(this._domElement,d.userDrag,"none"),d.setStyle(this._domElement,d.userSelect,"none"),d.setStyle(this._domElement,d.touchAction,"none"),d.setStyle(this._domElement,d.touchCallout,"none"),d.setStyle(this._domElement,d.tapHighlightColor,"rgba(0,0,0,0)"))},canvasDataURL:function(t){this.canvasSnapshot(function(e){t(e.toDataURL())})},canvasSnapshot:function(e){var t=document.createElement("canvas");t.width=this._size.width,t.height=this._size.height;var s=t.getContext("2d");this._rootNode.renderToCanvas(t,s,function(){e(t,s.getImageData(0,0,t.width,t.height))},this.domElement.style.backgroundColor)},setPointerDisplayVisible:function(e){assert&&assert("boolean"==typeof e),e!==!!this._pointerOverlay&&(e?(this._pointerOverlay=new T(this,this._rootNode),this.addOverlay(this._pointerOverlay)):(this.removeOverlay(this._pointerOverlay),this._pointerOverlay.dispose(),this._pointerOverlay=null))},setPointerAreaDisplayVisible:function(e){assert&&assert("boolean"==typeof e),e!==!!this._pointerAreaOverlay&&(e?(this._pointerAreaOverlay=new I(this,this._rootNode),this.addOverlay(this._pointerAreaOverlay)):(this.removeOverlay(this._pointerAreaOverlay),this._pointerAreaOverlay.dispose(),this._pointerAreaOverlay=null))},setCanvasNodeBoundsVisible:function(e){assert&&assert("boolean"==typeof e),e!==!!this._canvasAreaBoundsOverlay&&(e?(this._canvasAreaBoundsOverlay=new D(this,this._rootNode),this.addOverlay(this._canvasAreaBoundsOverlay)):(this.removeOverlay(this._canvasAreaBoundsOverlay),this._canvasAreaBoundsOverlay.dispose(),this._canvasAreaBoundsOverlay=null))},setFittedBlockBoundsVisible:function(e){assert&&assert("boolean"==typeof e),e!==!!this._fittedBlockBoundsOverlay&&(e?(this._fittedBlockBoundsOverlay=new C(this,this._rootNode),this.addOverlay(this._fittedBlockBoundsOverlay)):(this.removeOverlay(this._fittedBlockBoundsOverlay),this._fittedBlockBoundsOverlay.dispose(),this._fittedBlockBoundsOverlay=null))},resizeOnWindowResize:function(){var e=this,t=function(){e.setWidthHeight(window.innerWidth,window.innerHeight)};window.addEventListener("resize",t),t()},updateOnRequestAnimationFrame:function(s){var n=0,i=0,r=this;!function e(){r._requestAnimationFrameID=window.requestAnimationFrame(e,r._domElement);var t=(new Date).getTime();0!==n&&(i=(t-n)/1e3),n=t,s&&s(i),r.updateDisplay()}()},cancelUpdateOnRequestAnimationFrame:function(){window.cancelAnimationFrame(this._requestAnimationFrameID)},initializeEvents:function(e){assert&&assert(!this._input,"Events cannot be attached twice to a display (for now)");var t=new m(this,!this._listenToOnlyElement,this._batchDOMEvents,this._assumeFullWindow,this._passiveEvents,e);(this._input=t).connectListeners()},detachEvents:function(){assert&&assert(this._input,"detachEvents() should be called only when events are attached"),this._input.disconnectListeners(),this._input=null},addInputListener:function(e){return assert&&assert(!_.includes(this._inputListeners,e),"Input listener already registered on this Node"),_.includes(this._inputListeners,e)||this._inputListeners.push(e),this},removeInputListener:function(e){return assert&&assert(_.includes(this._inputListeners,e)),this._inputListeners.splice(_.indexOf(this._inputListeners,e),1),this},hasInputListener:function(e){for(var t=0;t<this._inputListeners.length;t++)if(this._inputListeners[t]===e)return!0;return!1},getInputListeners:function(){return this._inputListeners.slice(0)},get inputListeners(){return this.getInputListeners()},ensureNotPainting:function(){assert&&assert(!this._isPainting,"This should not be run in the call tree of updateDisplay(). If you see this, it is likely that either the last updateDisplay() had a thrown error and it is trying to be run again (in which case, investigate that error), OR code was run/triggered from inside an updateDisplay() that has the potential to cause an infinite loop, e.g. CanvasNode paintCanvas() call manipulating another Node, or a bounds listener that Scenery missed.")},loseWebGLContexts:function(){!function s(e){e.blocks&&e.blocks.forEach(function(e){e.gl&&B.loseContext(e.gl);for(var t=e.firstDrawable;null!==t&&(s(t),t!==e.lastDrawable);t=t.nextDrawable);})}(this._rootBackbone)},inspect:function(){localStorage.scenerySnapshot=JSON.stringify(w.serialize(this))},getDebugHTML:function(){var t="font-weight: bold; font-size: 120%; margin-top: 5px;",i=0,r="";r+='<div style="'+t+'">Display Summary</div>',r+=this._size.toString()+" frame:"+this._frameId+" input:"+!!this._input+" cursor:"+this._lastCursor+"<br/>",r+="Nodes: "+function e(t){for(var s=1,n=0;n<t.children.length;n++)s+=e(t.children[n]);return s}(this._rootNode)+"<br/>",r+=this._baseInstance?"Instances: "+function e(t){for(var s=1,n=0;n<t.children.length;n++)s+=e(t.children[n]);return s}(this._baseInstance)+"<br/>":"",r+=this._rootBackbone?"Drawables: "+function t(e){var s=1;if(e.blocks)_.each(e.blocks,function(e){s+=t(e)});else if(e.firstDrawable&&e.lastDrawable){for(var n=e.firstDrawable;n!==e.lastDrawable;n=n.nextDrawable)s+=t(n);s+=t(e.lastDrawable)}return s}(this._rootBackbone)+"<br/>":"";var s={};function a(e){var t=e.constructor.name;s[t]?s[t]++:s[t]=1}for(var e in r+=this._baseInstance?"Retained Drawables: "+function e(t){var s=0;t.selfDrawable&&(a(t.selfDrawable),s++),t.groupDrawable&&(a(t.groupDrawable),s++),t.sharedCacheDrawable&&(a(t.sharedCacheDrawable),s++);for(var n=0;n<t.children.length;n++)s+=e(t.children[n]);return s}(this._baseInstance)+"<br/>":"",s)r+="&nbsp;&nbsp;&nbsp;&nbsp;"+e+": "+s[e]+"<br/>";function o(e){if(e.firstDrawable&&e.lastDrawable){var t=e.domDrawable&&e.domDrawable.blocks,s='<div style="margin-left: '+20*i+'px">';if(s+=e.toString(),t||(s+=" ("+e.drawableCount+" drawables)"),s+="</div>",i+=1,t)for(var n=0;n<e.domDrawable.blocks.length;n++)s+=o(e.domDrawable.blocks[n]);return i-=1,s}}if(this._rootBackbone){r+='<div style="'+t+'">Block Summary</div>';for(var n=0;n<this._rootBackbone.blocks.length;n++)r+=o(this._rootBackbone.blocks[n])}function l(e){var t="";function s(e){t+=' <span style="color: #008">'+e+"</span>"}var n=e.node;t+=e.id,t+=" "+(n.constructor.name?n.constructor.name:"?"),t+=' <span style="font-weight: '+(n.isPainted()?"bold":"normal")+'">'+n.id+"</span>",t+=n.getDebugHTMLExtras(),n.visible||s("invis"),e.visible||s("I-invis"),e.relativeVisible||s("I-rel-invis"),e.selfVisible||s("I-self-invis"),e.fittability.ancestorsFittable||s("nofit-ancestor"),e.fittability.selfFittable||s("nofit-self"),!0===n.pickable&&s("pickable"),!1===n.pickable&&s("unpickable"),e.trail.isPickable()&&s('<span style="color: #808">hits</span>'),n.clipArea&&s("clipArea"),n.mouseArea&&s("mouseArea"),n.touchArea&&s("touchArea"),n.getInputListeners().length&&s("inputListeners"),n.getRenderer()&&s("renderer:"+n.getRenderer()),n.isLayerSplit()&&s("layerSplit"),n.opacity<1&&s("opacity:"+n.opacity),0<n._boundsEventCount&&s('<span style="color: #800">boundsListen:'+n._boundsEventCount+":"+n._boundsEventSelfCount+"</span>");var i,r="";switch(n.transform.getMatrix().type){case u.Types.IDENTITY:r="";break;case u.Types.TRANSLATION_2D:r="translated";break;case u.Types.SCALING:r="scale";break;case u.Types.AFFINE:r="affine";break;case u.Types.OTHER:r="other";break;default:throw new Error("invalid matrix type: "+n.transform.getMatrix().type)}return r&&(t+=' <span style="color: #88f" title="'+n.transform.getMatrix().toString().replace("\n","&#10;")+'">'+r+"</span>"),t+=' <span style="color: #888">[Trail '+e.trail.indices.join(".")+"]</span>",t+=' <span style="color: #c88">'+((i=e.state)?i.toString():i+"")+"</span>",t+=' <span style="color: #8c8">'+n._rendererSummary.bitmask.toString(16)+(n._rendererBitmask!==f.bitmaskNodeDefault?" ("+n._rendererBitmask.toString(16)+")":"")+"</span>"}function c(e){var t=e.toString();return e.visible&&(t="<strong>"+t+"</strong>"),e.dirty&&(t+=e.dirty?' <span style="color: #c00;">[x]</span>':""),e.fittable||(t+=e.dirty?' <span style="color: #0c0;">[no-fit]</span>':""),t}function h(e){var s='<div style="margin-left: '+20*i+'px">';function t(e,t){s+=' <span style="color: #888">'+e+":"+c(t)+"</span>"}s+=l(e),e.selfDrawable&&t("self",e.selfDrawable),e.groupDrawable&&t("group",e.groupDrawable),e.sharedCacheDrawable&&t("sharedCache",e.sharedCacheDrawable),r+=s+="</div>",i+=1,_.each(e.children,function(e){h(e)}),i-=1}return this._baseInstance&&(r+='<div style="'+t+'">Root Instance Tree</div>',h(this._baseInstance)),_.each(this._sharedCanvasInstances,function(e){r+='<div style="'+t+'">Shared Canvas Instance Tree</div>',h(e)}),this._rootBackbone&&(r+='<div style="font-weight: bold;">Root Drawable Tree</div>',function t(e){var s='<div style="margin-left: '+20*i+'px">';if(s+=c(e),e.instance?(s+=' <span style="color: #0a0;">('+e.instance.trail.toPathString()+")</span>",s+="&nbsp;&nbsp;&nbsp;"+l(e.instance)):e.backboneInstance&&(s+=' <span style="color: #a00;">('+e.backboneInstance.trail.toPathString()+")</span>",s+="&nbsp;&nbsp;&nbsp;"+l(e.backboneInstance)),r+=s+="</div>",e.blocks)i+=1,_.each(e.blocks,function(e){t(e)}),i-=1;else if(e.firstDrawable&&e.lastDrawable){i+=1;for(var n=e.firstDrawable;n!==e.lastDrawable;n=n.nextDrawable)t(n);t(e.lastDrawable),i-=1}}(this._rootBackbone)),r},popupDebug:function(){var e='<!DOCTYPE html><html lang="en"><head><title>Scenery Debug Snapshot</title></head><body style="font-size: 12px;">'+this.getDebugHTML()+"</body></html>";window.open("data:text/html;charset=utf-8,"+encodeURIComponent(e))},getAccessibleDebugHTML:function(){var n="",e="font-weight: bold; font-size: 120%; margin-top: 5px;",i="&nbsp;&nbsp;&nbsp;&nbsp;";n+='<div style="'+e+'">Accessible Instances</div><br>',function t(e,s){n+=s+c((e.isRootInstance?"":e.node.tagName)+" "+e.toString())+"<br>";e.children.forEach(function(e){t(e,s+i)})}(this._rootAccessibleInstance,""),n+='<br><div style="'+e+'">Parallel DOM</div><br>';for(var t=this._rootAccessibleInstance.peer.primarySibling.outerHTML,s=(t=t.replace(/\>\</g,">\n<")).split("\n"),r="",a=0;a<s.length;a++){var o=s[a],l="</"===o.slice(0,2);l&&(r=r.slice(i.length)),n+=r+c(o)+"<br>",l||(r+=i)}return n},foreignObjectRasterization:function(e){var t={},s=0;function n(e){e.id||(e.id="unknown-canvas-"+s++),t[e.id]=e.toDataURL()}!function t(e){if(e.blocks)_.each(e.blocks,function(e){t(e)});else if(e.firstDrawable&&e.lastDrawable){for(var s=e.firstDrawable;s!==e.lastDrawable;s=s.nextDrawable)t(s);t(e.lastDrawable),e.canvas&&e.canvas instanceof window.HTMLCanvasElement&&n(e.canvas)}w.DOMDrawable&&e instanceof w.DOMDrawable&&(e.domElement instanceof window.HTMLCanvasElement&&n(e.domElement),Array.prototype.forEach.call(e.domElement.getElementsByTagName("canvas"),function(e){n(e)}))}(this._rootBackbone);var i=document.implementation.createHTMLDocument("");i.documentElement.innerHTML=this.domElement.outerHTML,i.documentElement.setAttribute("xmlns",i.documentElement.namespaceURI);var r=i.documentElement.getElementsByTagName("canvas");r=Array.prototype.slice.call(r);for(var a=0;a<r.length;a++){var o=r[a],l=o.style.cssText,c=i.createElement("img"),h=t[o.id];assert&&assert(h,"Must have missed a toDataURL() on a Canvas"),c.src=h,c.setAttribute("style",l),o.parentNode.replaceChild(c,o)}for(var u=this.width,d=this.height,p=function(){N.elementToSVGDataURL(i.documentElement,u,d,e)},g=0,y=!1,b=Array.prototype.slice.call(i.documentElement.getElementsByTagName("image")),f=0;f<b.length;f++){var m=b[f],v=m.getAttribute("xlink:href");"data:"!==v.slice(0,5)&&(g++,y=!0,function(){var t=new window.Image,s=m;t.onload=function(){var e=document.createElement("canvas");e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),s.setAttribute("xlink:href",e.toDataURL()),0==--g&&p(),assert&&assert(0<=g)},t.onerror=function(){0==--g&&p(),assert&&assert(0<=g)},t.src=v}())}y||p()},popupRasterization:function(){this.foreignObjectRasterization(window.open)}},n.prototype),{elementToSVGDataURL:function(e,t,s,n){var i=document.createElement("canvas"),r=i.getContext("2d"),a='<svg xmlns="http://www.w3.org/2000/svg" width="'+(i.width=t)+'" height="'+(i.height=s)+'"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">'+(new window.XMLSerializer).serializeToString(e)+"</div></foreignObject></svg>",o=new window.Image;o.onload=function(){r.drawImage(o,0,0),n(i.toDataURL())},o.onerror=function(){n(null)};var l=new window.TextEncoderLite("utf-8").encode(a),c=window.fromByteArray(l);o.src="data:image/svg+xml;base64,"+c},set focus(e){if(window.phet&&phet.phetio&&phet.chipper.accessibility&&e){var t=e.trail.lastNode();assert&&assert(t.isPhetioInstrumented(),"When running phet-io mode, all focusable instances must be instrumented.")}var s;this.focusProperty.value&&(s=this.focusedNode).focusChangedEmitter.emit1(!1),(this.focusProperty.value=e)?e.trail.lastNode().focusChangedEmitter.emit1(!0):s&&s.blur()},get focus(){return this.focusProperty.value},getFocusedNode:function(){var e=null,t=this.focusProperty.get();return t&&(e=t.trail.lastNode()),e},get focusedNode(){return this.getFocusedNode()}}),N.prototype.dispose=function(){this._input&&this.detachEvents(),this._rootNode.removeRootedDisplay(this),this._accessible&&this._rootAccessibleInstance.dispose()},N.customCursors={"scenery-grab-pointer":["grab","-moz-grab","-webkit-grab","pointer"],"scenery-grabbing-pointer":["grabbing","-moz-grabbing","-webkit-grabbing","pointer"]},N.focusProperty=new a(null,window.phet&&phet.chipper&&phet.chipper.accessibility?{tandem:h.rootTandem.createTandem("display").createTandem("focusProperty"),phetioType:l(S(L))}:{}),N.userGestureEmitter=new t,N.assertSubtreeDisposed=function(e){if(assert&&assert(!e.isDisposed(),"Disposed nodes should not be included in a scene graph to display."),assert)for(var t=0;t<e.children.length;t++)N.assertSubtreeDisposed(e.children[t])},N});